---
title: ff数字藏品交易系统的搭建
author: Fnkk
avatar: https://cdn.jsdelivr.net/gh/fnkk/resource@0.0.2/img/mayi.jpg
authorLink: fnkk.io
authorAbout: Fnkk
authorDesc: Fnkk
categories: 技术
date: 2023-3-31 15:51:01
comments: true
keywords: block chain
description: 设计思路
photos: https://cdn.jsdelivr.net/gh/fnkk/resource@0.0.2/img/mayi.jpg
---
# 毕业设计系统设计的思路
## 铸造NFT(nft信息可能还需要铸造时间、作者等信息)
- WTF的铸造NFT合约的铸造函数mint() 只需要两个参数，tokenId和生成后NFT的地址。这显然是不符合我的需求的，需要改造。
1. 生成NFT的tokenId自动生成，自增，容量上限为10000个。
2. 生成NFT后的默认地址为使用的用户的地址
3. 生成NFT需要一些额外的参数：图片信息（最重要的信息，应该是一个IPFS的地址哈希值），一些描述（用于展示NFT时描述，如：作者、名称等，不作为生成的条件）。
#### 修改ERC721.sol 思路(已完成)
1. tokenId 数据类型从uint改为string,从_mint函数的入参获得变为 图片地址哈希+nft名称+简介(或者简介存入ipfs的哈希) 通过sha256生成的值,不在设最大token数量(或者添加一个tokenNumber记录当前nft数量,并定义最大数量)。
5. tokenId 的数据类型只能是uint 所以tokenId改为数字自增,
2. _mint函数入参改变为 用户地址+图片哈希+name+简介 通过computedTokenId()函数获取tokenId的值,后续逻辑不变
3. 定义一个mapping(tokenId => tokenDetail),tokenDetail为一个struct,包含tokenId,picUrl,introduction,name四个字段。
4. 定义一个getTokenDetail函数 输入tokenId获取tokenDetail的内容

## 追溯NFT
- 查询交易记录的功能
1. 输入tokenID查询这个NFT的所有被交易信息。
2. 输入一个账号地址，查询该账号的所有交易记录。
3. 需要利用事件存储交易信息到数据库,再在数据库中操作查询交易记录(node.js和mongoDb的操作,数据库如何设计,是否有必要记录其他更多的数据,实现完整的链下生态)
4. planB: 前端直接通过事件拿到所有信息,然后在前端进行数据处理展示,这样可以跳过node和mongo,但是逻辑可能也很复杂。

## 首页
- 一个走马灯,一个背景图,然后其他几个页面跳跳算了。

## 个人中心
- 查看本人持有的所有NFT(已完成)
- 本人所有交易记录,功能上隶属于追溯(不一定做,大概率放弃)
- 每个nft有两个按钮,分别是转赠和拍卖,分别跳转至转赠和新增拍卖页面。

## 数字博物馆
- 展示所有NFT作品，无限滚动、懒加载
- 还是采用分页的方式,简单一点,重写分页的方法即可。
- 和个人列表一致,采用card的形式展示,点击查看NFT作品详情。多一个该nft所有的交易记录信息,作者,持有人,创建时间

## 数字藏品拍卖
- 用户可以提交自己持有的NFT进行拍卖
- 拍卖所展示被拍卖的NFT 分类分列：待开始、进行中、已结束。
- 拍卖流程同e-bay

## 数据库设计
- nft表
tokenId name introduction picUrl createdTime author owner transferSum
查询owner获取个人所有nft
查询所有信息获取所有nft
- 交易记录表
tokenId from to transferTime
查询tokenId返回所有记录就是追溯的结果。
- 拍卖表
有点多晚点再说
- 合约事件设计
只要一个新增NFT的事件即可,transfer事件既新增交易记录表,又更新nft表

# 毕业论文大纲
- 目录
0. 摘要
    - 第一句讲背景，第二局讲做了什么，怎么做了，结果是啥
    随着“元宇宙”概念的爆火，与“元宇宙”相关的产业如雨后春笋般涌现出来。最典型的代表就是 NFT，它是表示数字资产的货币令牌，可以在网络上进行买卖，具备一定的货币属性。NFT 传入国内后，经过一定时间的发展，衍生成为了现在的数字藏品。数字藏品作为一种新兴的收藏品，为满足广大数字藏品爱好者的需要，本文尝试通过区块链技术，设计并实现了基于区块链数字藏品交易系统，旨在让人们体验、感受数字藏品的魅力。
    需求分析用例。vision
1. 绪论
    - 研究背景及意义
    - 国内外研究现状
        1. 区块链现状
        2. 数字藏品现状
    - 本文主要工作
2. 相关理论技术介绍
    - 区块链技术概述
    - node.js和mongodb概述
    Node.js是一个基于Chrome V8引擎的开源、跨平台的JavaScript运行时环境。它允许开发者使用JavaScript来编写服务器端代码，以及使用JavaScript语言处理数据和事件。Node.js的出现极大地推动了JavaScript在服务器端的应用，并且成为了现代Web开发中不可或缺的一部分。Node.js提供了一些核心模块和第三方模块，使得开发者可以方便地构建高性能、可扩展的Web应用、网络工具和命令行工具。同时，Node.js还有着丰富的社区和文档资源，为开发者提供了强大的支持。
    MongoDB是一种NoSQL数据库，采用了分布式文件存储的方式，以键值对的形式存储数据。它是一个高性能、可扩展、易部署的开源数据库，特别适合大规模的数据存储。相比传统的关系型数据库，MongoDB具有更高的可扩展性和更好的性能，在大数据处理和高并发场景中表现优异。同时，它还提供了灵活的数据模型和查询方式，使得开发者可以更加自由地设计和操作数据。MongoDB广泛应用于Web应用程序、移动应用程序、大数据、物联网等领域。
    - IPFS概述
    - react和web3.js概述
3. 数字藏品交易系统的分析与设计
    - 引入区块链的必要性 
    将数字藏品存储在区块链上，可以使用智能合约确保每个数字藏品的唯一性和不可更改性，避免了数字藏品被复制、篡改等问题，可以增强数字藏品的唯一性和可信度。其次，区块链技术使用密码学和分布式网络的去中心化存储可以保护数据安全，有效防止数字藏品被黑客攻击或中心化服务器故障导致数据丢失。再者，使用使用区块链技术进行数字藏品交易，可以节省传统的中介费用和交易成本，同时通过智能合约和分布式网络实现的去中心化交易，保证每个交易的公平和公正，提供更加透明和公正的数字藏品交易平台。
    - 数字藏品交易系统需求分析
    用户能够创建自己的数字藏品，同时能够查看其它用户创建的数字藏品。数字藏品的拥有者可以对它进行转赠和出售两种操作，用户可以购买被出售的数字藏品。数字藏品的所有交易都是公开透明的，可以追溯历史交易记录。
    - 数字藏品交易系统架构设计。
    区块链作为一种分布式存储系统，能确保数据永久保存无法篡改，但是图片等大体积数据上链成本高，数据量大时查询效率低，所以本系统分为链上、链下两部分。其中链上部分为区块链存储，将数字藏品的创建、交易等信息通过智能合约接口存储到区块链上，保证数据真实可靠。同时依靠智能合约的事件监听，同步一份数据到传统数据库中，后续对数据的查询可以访问数据库提高查询效率。由于区块链上的数据可以追溯，如果怀疑数据库中的数据被篡改，可以查询区块链的历史数据与数据库进行对比，确保数据的真实可靠。将高清图片存储至IPFS系统，仅把IPFS返回的哈希值存储至区块链中，减少存储成本。最后构建前端界面，与区块链和后端进行交互，实现核心功能，如下图：...。
    - 数字藏品交易系统核心功能设计。
        1. 数字藏品创建
            用户上传图片至IPFS，填写名称、简介等信息后，即可生成数字藏品。
        2. 数字藏品转赠
            用户选择要转赠的数字藏品，填写被转赠的用户地址，即可完成转赠。
        3. 数字藏品交易
            用户选择要出售的数字藏品，填写要出售的价格，即可创建交易单号，在交易完成之前，可以进行价格修改、撤单的操作。用户可以在数字藏品交易中心查看发起交易的数字藏品，并选择是否购买。
        4. 数字藏品溯源
            用户输入数字藏品的唯一标识tokenId后，可以查找到该数字藏品的历史交易记录。
4. 数字藏品交易系统的实现
    - 区块链环境搭建
        区块链按照去中心化程度由高到低分为：公链，联盟链，私链。因为公共网络的区块数量太多，同步耗时太长，为了方便本地开发与合约测试，本文搭建以太坊私链作为区块链的环境，后续如有需要，可以将智能合约部署至公链。
        下载geth客户端windows版本，然后需要创建网络的“创世”（genesis）状态，这写在一个JSON文件里（将其命名为genesis.json）：
        {
            "config": {
                "chainId": 666
            },
            "difficulty": "2000",
            "gasLimit": "2100000",
            "alloc": {
                "7df9a875a174b3bc565e6424a0050ebc1b2d1d82": { "balance":        "300000" },
                "f41c74c9ae680c1aa78f42e5647a62f353b7bdde": { "balance":        "400000" }
            }
        }
        其中chainId为区块链Id，需要和主流公链不一样，difficulty为挖矿难度，gasLimit为交易时最大gas限制，alloc为初始账号设置。
        在终端运行：geth --datadir init genesis.json命令创建一条id为666的私链。创建完成后运行：geth --datadir --networkid 666 就可以成功运行以太坊节点。至此区块链开发环境搭建完成。
    - 智能合约编写及部署
        基于本系统主要功能，拆分成数字藏品铸造和数字藏品交易两个主合约实现相应功能。
        1. ERC721.sol(数字藏品铸造合约)：继承IERC721合约。
        IERC721是一个标准的智能合约接口，用于在以太坊区块链上定义非同质化代币（NFT）。这个接口规范了创建、转让和销毁NFT的方法，同时定义了一个标准的元数据（metadata）格式，使得不同的应用可以共享和处理这些NFT。
        表：IERC721的事件和函数   表：ERC721的事件和函数(这里新增了不少东西)
        2. NFTSwap.sol(数字藏品交易合约)：主要实现挂单、购买、修改价格和撤单
        编写完成合约代码后，运行truffle compile命令编译代码。
        编写迁移脚本
        运行truffle migration完成智能合约的部署。
    - IPFS系统实现
        本文引入IPFS用于存储数字藏品的高清图片。首先从IPFS官网下载go语言实现版本，在安装、配置环境之后，运行ipfs daemon命令，启动IPFS服务并在5001端口监听。IPFS网络情况如图...所示，图中数据表示本机所处网络已经覆盖了...个节点。其中本机所运行的节点地址为...

        本系统与IPFS的交互主要在前端功能上，详情见前端实现部分。
    - 链下功能实现
        安装express、mongoose、web3等依赖，分别用于构建后端服务、与mongo
        数据库交互、与geth客户端交互的功能。
        1. 数据库设计
            根据系统的需求分析，设计了如下三张表：nfts、transfers、swaps分别用于记录数字藏品信息、交易记录信息和交易单信息。 
            三张表具体信息。
        2. 创建实体Schema对象。通过Schema对象对数据库进行添加修改操作
        3. 获取合约对象
            引入合约编译好的json，通过web3.js获取合约对象。监听合约对象的事件，触发不同的事件后对数据库进行相应的操作。
        4. 根据需求，编写后端接口，返回需要的数据
        
    - 前端实现
        前端采用React框架+Antd组件库构建前端页面。
        介绍+贴图。
5. 数字藏品交易系统的测试
    - 数字藏品上传测试
    - 数字藏品转赠测试
    - 数字藏品交易测试
    - 数字藏品溯源测试
6. 总结与展望